<!DOCTYPE html>
<meta charset="utf-8">
<title>Cubism.js</title>
<style>
@import url(//fonts.googleapis.com/css?family=Yanone+Kaffeesatz:400,700);
@import url(//square.github.com/cubism/style.css);

#jbuchmetric { min-height: 155px; }
</style>
<div id="body">
  <h2>Metric:</h2>
  <div id="jbuchmetric" ></div>
  <div id="example1" ></div>
</div>
<script type="text/javascript" src="http://d3js.org/d3.v2.js"></script>
<script type="text/javascript" src="http://raw.github.com/square/cubism/master/cubism.v1.js"></script>
<script type="text/javascript" src="http://code.jquery.com/jquery-1.8.2.min.js"></script>
<script type="text/javascript">
var jbuchCtxgen = function(host) {
  if (!arguments.length) host = "localhost:8080";
  var source = {};/*,
      context = this;*/

  var cubism_cubeFormatDate = d3.time.format.iso;

  source.metric = function(site, expression) {
    return context.metric(function(start, stop, step, callback) {
      var url = host + "/1.0/metric"
          + "?site=" + encodeURIComponent(site)
          + "&expression=" + encodeURIComponent(expression)
          + "&start=" + cubism_cubeFormatDate(start)
          + "&stop=" + cubism_cubeFormatDate(stop)
          + "&step=" + step;
      d3.json(url, function(data) {
          if (!data) return callback(new Error("unable to load data"));
          data.forEach(function(d) {
            cubism_cubeFormatDate.parse(d.date);
            d.value = parseInt(d.value);
          });
          console.log("Got data from "+host+" , count: "+data.length);
          callback(null, data.map(function (d) { return d.value; }) );
      });
    }, ""+site+" "+expression);
  };

  // Returns the Cube host.
  source.toString = function() {
    return ""+site+" "+expression;
  };

  return source;
};

    </script>
    <script type="text/javascript">

/*
var context = cubism.context()
    .serverDelay(50)
    .clientDelay(10)
    .step(20 * 1e3)
    .size(1440);
*/
var context = cubism.context()
      .serverDelay(500)
      .clientDelay(100)
      .step(10e3)
      .size(960);

var jbuchctx = jbuchCtxgen("http://localhost:8080");
var metric_free = jbuchctx.metric("TST", "free");
var metric_total = jbuchctx.metric("TST", "total");
var metric_threads = jbuchctx.metric("TST", "threads");

var metric_used = metric_total.subtract(metric_free);
var lastWeek = metric_used.shift(-7 * 24 * 60 * 60 * 1000);

metric_used.toString = function() { return "Used" };
metric_threads.toString = function() { return "Threads" };
lastWeek.toString = function() { return "LastWeek" };


var colorsRed = ["#FDBE85", "#FEEDDE", "#FD8D3C", "#E6550D", "#A63603", "#FDBE85", "#FEEDDE", "#FD8D3C", "#E6550D", "#A63603" ],
        colorsGreen = [ "#E5F5F9", "#99D8C9", "#2CA25F", "#E5F5F9", "#99D8C9", "#2CA25F"],
            colorsBlue = [ "#ECE7F2", "#A6BDDB", "#2B8CBE", "#ECE7F2", "#A6BDDB", "#2B8CBE"];

d3.select("#jbuchmetric").call(function(div) {

  div.append("div")
      .attr("class", "axis")
      .call(context.axis().orient("top"));

  div.selectAll(".horizon")
      .data([metric_used, metric_threads])
      .enter().append("div")
      .attr("class", "horizon")
      .call(context.horizon()/*.extent([0, 1500])*/
        .colors(function (d,i) { console.log(d); console.log(i); return i & 1 > 0 ? colorsBlue : colorsGreen; }));

  div.append("div")
      .attr("class", "rule")
      .call(context.rule());
});

// On mousemove, reposition the chart values to match the rule.

context.on("focus", function(i) {
  d3.selectAll(".value").style("right", i == null ? null : context.size() - i + "px");
});
    </script>
  </body>
</html>
